<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <apiVersion>55.0</apiVersion>
    <assignments>
        <name>AssignCampaignMemberExist</name>
        <label>Assign Campaign Member Exist</label>
        <locationX>50</locationX>
        <locationY>1055</locationY>
        <assignmentItems>
            <assignToReference>$Record.Notes__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Contact already exists as a Campaign Member for Campaign</stringValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>AssignCompleteCampaign</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>AssignCompleteCampaign</name>
        <label>Assign Complete Campaign</label>
        <locationX>314</locationX>
        <locationY>1859</locationY>
        <assignmentItems>
            <assignToReference>$Record.Status__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Complete</stringValue>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>$Record.Campaign__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>GetCampaign.Id</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>$Record.Contact__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>ContactIdFormula</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>$Record.OperatingCompany__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>GetCampaign.OperatingCompany__c</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>UpdateLivestormImportRecord</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>FlowErrorAssignment</name>
        <label>Flow Error Assignment</label>
        <locationX>578</locationX>
        <locationY>1415</locationY>
        <assignmentItems>
            <assignToReference>$Record.Status__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Error</stringValue>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>$Record.ErrorReason__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$Flow.FaultMessage</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <isGoTo>true</isGoTo>
            <targetReference>UpdateLivestormImportRecord</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>NoCampaignFoundError</name>
        <label>No Campaign Found Error</label>
        <locationX>1810</locationX>
        <locationY>575</locationY>
        <assignmentItems>
            <assignToReference>$Record.Status__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Error</stringValue>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>$Record.ErrorReason__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>No Matching Campaign was found</stringValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>UpdateLivestormImportRecord</targetReference>
        </connector>
    </assignments>
    <decisions>
        <name>ContactCampaignMember</name>
        <label>Contact Campaign Member</label>
        <locationX>314</locationX>
        <locationY>935</locationY>
        <defaultConnector>
            <targetReference>CreateCampaignMember</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Contact not member</defaultConnectorLabel>
        <rules>
            <name>Contact_is_member</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>GetCampaignMember</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>AssignCampaignMemberExist</targetReference>
            </connector>
            <label>Contact is member</label>
        </rules>
    </decisions>
    <decisions>
        <name>EmailConsentGiven</name>
        <label>Email Consent Given</label>
        <locationX>578</locationX>
        <locationY>1175</locationY>
        <defaultConnector>
            <targetReference>AssignCompleteCampaign</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>ConsentGiven</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Record.EmailConsent__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>CreatePrivacyPermsiion</targetReference>
            </connector>
            <label>Consent Given</label>
        </rules>
    </decisions>
    <decisions>
        <name>FoundCampaign</name>
        <label>Found Campaign</label>
        <locationX>1304</locationX>
        <locationY>455</locationY>
        <defaultConnector>
            <targetReference>NoCampaignFoundError</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Campaign Not Found</defaultConnectorLabel>
        <rules>
            <name>CampaignFound</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>GetCampaign</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>GetContact</targetReference>
            </connector>
            <label>Campaign Found</label>
        </rules>
    </decisions>
    <decisions>
        <name>FoundContact</name>
        <label>Found Contact</label>
        <locationX>798</locationX>
        <locationY>695</locationY>
        <defaultConnector>
            <targetReference>GetLivestormConfigurationMdt</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Contact Not Found</defaultConnectorLabel>
        <rules>
            <name>ContactFound</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>GetContact</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>GetCampaignMember</targetReference>
            </connector>
            <label>Contact Found</label>
        </rules>
    </decisions>
    <description>Add/Create Contact Campaign Member to Campaign when a person registers on Livestorm and a Livestorm Import record is created for the attendee.</description>
    <environments>Default</environments>
    <formulas>
        <description>Use ContactId from GetContact if the Contact was queried and not created</description>
        <name>ContactIdFormula</name>
        <dataType>String</dataType>
        <expression>IF( ISBLANK( {!CreateContact} ), {!GetContact.Id}, {!CreateContact})</expression>
    </formulas>
    <interviewLabel>Livestorm Webinar Handler {!$Flow.CurrentDateTime}</interviewLabel>
    <label>Livestorm Webinar Handler</label>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>AUTO_LAYOUT_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>AutoLaunchedFlow</processType>
    <recordCreates>
        <name>CreateCampaignMember</name>
        <label>Create Campaign Member</label>
        <locationX>578</locationX>
        <locationY>1055</locationY>
        <connector>
            <targetReference>EmailConsentGiven</targetReference>
        </connector>
        <faultConnector>
            <isGoTo>true</isGoTo>
            <targetReference>FlowErrorAssignment</targetReference>
        </faultConnector>
        <inputAssignments>
            <field>CampaignId</field>
            <value>
                <elementReference>GetCampaign.Id</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>ContactId</field>
            <value>
                <elementReference>ContactIdFormula</elementReference>
            </value>
        </inputAssignments>
        <object>CampaignMember</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordCreates>
    <recordCreates>
        <name>CreateContact</name>
        <label>Create Contact</label>
        <locationX>1282</locationX>
        <locationY>935</locationY>
        <connector>
            <isGoTo>true</isGoTo>
            <targetReference>CreateCampaignMember</targetReference>
        </connector>
        <faultConnector>
            <isGoTo>true</isGoTo>
            <targetReference>FlowErrorAssignment</targetReference>
        </faultConnector>
        <inputAssignments>
            <field>AccountId</field>
            <value>
                <elementReference>GetLivestormConfigurationMdt.DummyAccountId__c</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Email</field>
            <value>
                <elementReference>$Record.AttendeeEmail__c</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>FirstName</field>
            <value>
                <elementReference>$Record.AttendeeFirstName__c</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>LastName</field>
            <value>
                <elementReference>$Record.AttendeeLastName__c</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>OperatingCompany__c</field>
            <value>
                <elementReference>GetCampaign.OperatingCompany__c</elementReference>
            </value>
        </inputAssignments>
        <object>Contact</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordCreates>
    <recordCreates>
        <description>Create a new privacy permission related to the contact</description>
        <name>CreatePrivacyPermsiion</name>
        <label>Create Privacy Permsiion</label>
        <locationX>314</locationX>
        <locationY>1295</locationY>
        <connector>
            <isGoTo>true</isGoTo>
            <targetReference>AssignCompleteCampaign</targetReference>
        </connector>
        <faultConnector>
            <targetReference>FlowErrorAssignment</targetReference>
        </faultConnector>
        <inputAssignments>
            <field>Channel__c</field>
            <value>
                <stringValue>Email</stringValue>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Contact__c</field>
            <value>
                <elementReference>ContactIdFormula</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Description__c</field>
            <value>
                <stringValue>Consent via Livestorm event </stringValue>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>ListId__c</field>
            <value>
                <stringValue>1</stringValue>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Name</field>
            <value>
                <stringValue>News</stringValue>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Origin__c</field>
            <value>
                <stringValue>Event</stringValue>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Status__c</field>
            <value>
                <stringValue>Opt in</stringValue>
            </value>
        </inputAssignments>
        <object>PrivacyPermission__c</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordCreates>
    <recordLookups>
        <name>GetCampaign</name>
        <label>Get Campaign</label>
        <locationX>1304</locationX>
        <locationY>335</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>FoundCampaign</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>LivestormId__c</field>
            <operator>IsNull</operator>
            <value>
                <booleanValue>false</booleanValue>
            </value>
        </filters>
        <filters>
            <field>LivestormId__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.WebinarIdentify__c</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>Campaign</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <description>Check to see if Contact is already a Campaign Member</description>
        <name>GetCampaignMember</name>
        <label>Get Campaign Member</label>
        <locationX>314</locationX>
        <locationY>815</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>ContactCampaignMember</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>CampaignId</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>GetCampaign.Id</elementReference>
            </value>
        </filters>
        <filters>
            <field>ContactId</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>GetContact.Id</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>CampaignMember</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>GetContact</name>
        <label>Get Contact</label>
        <locationX>798</locationX>
        <locationY>575</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>FoundContact</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Email</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.AttendeeEmail__c</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>Contact</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>GetLivestormConfigurationMdt</name>
        <label>Get Livestorm Configuration Mdt</label>
        <locationX>1282</locationX>
        <locationY>815</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>CreateContact</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>OperatingCompany__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>GetCampaign.OperatingCompany__c</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>LivestormWebinarConfiguration__mdt</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordUpdates>
        <name>UpdateLivestormImportRecord</name>
        <label>Update Livestorm Import Record</label>
        <locationX>1304</locationX>
        <locationY>2171</locationY>
        <inputReference>$Record</inputReference>
    </recordUpdates>
    <start>
        <locationX>1178</locationX>
        <locationY>0</locationY>
        <connector>
            <targetReference>GetCampaign</targetReference>
        </connector>
        <doesRequireRecordChangedToMeetCriteria>true</doesRequireRecordChangedToMeetCriteria>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Status__c</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>Pending</stringValue>
            </value>
        </filters>
        <object>LivestormImport__c</object>
        <recordTriggerType>CreateAndUpdate</recordTriggerType>
        <triggerType>RecordAfterSave</triggerType>
    </start>
    <status>Active</status>
</Flow>
